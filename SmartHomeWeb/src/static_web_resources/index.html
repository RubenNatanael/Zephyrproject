<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nucleo Smart Hub</title>
    <style>
        :root { --bg: #0f172a; --card: rgba(255,255,255,0.05); --primary: #8b5cf6; --text-dim: #94a3b8; }
        body { 
            background: var(--bg); color: white; font-family: sans-serif; 
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, 320px); gap: 20px; justify-content: center; width: 100%; }
        .card { 
            background: var(--card); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 24px; padding: 20px; transition: 0.3s; overflow: hidden; height: 300px;
        }
        .card.expanded { height: 520px; border-color: var(--primary); }
        .flex { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        
        /* Toggle Styling */
        .switch { width: 44px; height: 24px; position: relative; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #334155; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Dual Temp Display */
        .temp-box { position: relative; width: 180px; height: 140px; margin: 10px auto; touch-action: none; cursor: pointer;}
        .temp-display { 
            position: absolute; bottom: 5px; width: 100%; text-align: center; 
            display: flex; flex-direction: column; align-items: center; line-height: 1;
        }
        .real-val { font-size: 2.8rem; font-weight: 800; color: #fff; }
        .target-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; margin-top: 8px; letter-spacing: 1px;}
        .target-val { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        
        .schedule { opacity: 0; margin-top: 20px; transition: 0.3s; pointer-events: none; }
        .expanded .schedule { opacity: 1; pointer-events: auto; }
        .sched-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin-bottom: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <h2 style="color: #a855f7; margin-bottom: 30px;">Nucleo Control</h2>
    <div class="grid" id="container"></div>

    <script>
        // "temp" is what the sensor reads. "setpoint" is what the user wants.
        const rooms = [
            { room_id: 0, room_name: 'Test Room', temp_sensor_value: 24, desired_temperature: 22, light_gpio_value: 1, hum_sensor_value: 50 },
            { room_id: 1, room_name: 'Living Room', temp_sensor_value: 24, desired_temperature: 22, light_gpio_value: 1, hum_sensor_value: 45 },
            { room_id: 2, room_name: 'Bedroom', temp_sensor_value: 20, desired_temperature: 19, light_gpio_value: 0, hum_sensor_value: 40 },
            { iroom_idd: 3, room_name: 'Kitchen', temp_sensor_value: 22, desired_temperature: 21, light_gpio_value: 1, hum_sensor_value: 55 }
        ];

        function createCard(r) {
            return `
            <div class="card" id="card-${r.room_id}">
                <div class="flex">
                    <span style="font-weight:bold">${r.room_name}</span>
                    <button class="icon-btn" onclick="toggleEx(${r.room_id})">‚öôÔ∏è</button>
                </div>
                <div class="flex" style="margin: 15px 0; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 15px;">
                    <span>üí° Light</span>
                    <label class="switch">
                        <input type="checkbox" ${r.light_gpio_value ? 'checked' : ''} onchange="postLight(${r.room_id}, this.checked ? 1 : 0)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="temp-box" onmousedown="startDrag(event, ${r.room_id})" ontouchstart="startDrag(event, ${r.room_id})">
                    <svg viewBox="0 0 100 50" width="180">
                        <path d="M 10,45 A 40,40 0 0,1 90,45" fill="none" stroke="#2d2d44" stroke-width="6" stroke-linecap="round"/>
                        <path id="prog-${r.room_id}" d="M 10,45 A 40,40 0 0,1 90,45" fill="none" stroke="#8b5cf6" stroke-width="7" stroke-linecap="round" stroke-dasharray="0, 126"/>
                    </svg>
                    <div class="temp-display">
                        <div class="real-val"><span id="real-${r.room_id}">${r.temp_sensor_value}</span>¬∞</div>
                        <div class="target-label">Target</div>
                        <div class="target-val"><span id="set-${r.room_id}">${r.desired_temperature}</span>¬∞</div>
                    </div>
                </div>
                <div class="schedule">
                    <div class="sched-item flex"><span>Morning</span><b>21¬∞C</b></div>
                    <div class="sched-item flex"><span>Night</span><b>18¬∞C</b></div>
                </div>
            </div>`;
        }

        let dragging = false, activeId = null;

        function toggleEx(id) { document.getElementById(`card-${id}`).classList.toggle('expanded'); }
        function startDrag(e, id) { dragging = true; activeId = id; update(e); }
        
        window.onmousemove = window.ontouchmove = (e) => { if(dragging) update(e.touches ? e.touches[0] : e); };
        
        window.onmouseup = window.ontouchend = () => { 
            if(dragging) {
                const targetTemp = parseInt(document.getElementById(`set-${activeId}`).innerText);
                postTemp(activeId, targetTemp);
            }
            dragging = false; 
        };

        function update(e) {
            const box = document.querySelector(`#card-${activeId} .temp-box`);
            const rect = box.getBoundingClientRect();
            let p = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
            let t = Math.round(16 + (p * 14)); // Range 16-30
            document.getElementById(`set-${activeId}`).innerText = t;
            document.getElementById(`prog-${activeId}`).style.strokeDasharray = `${p * 126}, 126`;
        }

        // Call nucleo code to set light/led
        async function postLight(roomId, value) {
            let path_url = '/api/v1/light';
            let payload = JSON.stringify({"room_id" : roomId, "light_gpio_value" : value});
            if (roomId == 0 ) {
                path_url = '/api/v1/led';
                payload = JSON.stringify({"led_num" : roomId, "led_val" : value});
            }
            try {
                await fetch(path_url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
            } catch (err) { console.error("Nucleo Offline", err); }
        }

        // Call nucleo code to set temperature
        async function postTemp(roomId, value) {
            try {
                const payload = JSON.stringify({"room_id" : roomId, "desire_temp_value" : value});
                await fetch('/api/v1/temp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
            } catch (err) { console.error("Nucleo Offline", err); }
        }

        async function fetchRooms() {
            const container = document.getElementById('container');
            container.innerHTML = '<p style="color: var(--text-dim);">Loading rooms...</p>';

            try {
                const response = await fetch('/api/v1/rooms');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const rooms = await response.json();

                // Clear the container and populate it with fetched room data
                container.innerHTML = rooms.map(createCard).join('');

                // Update progress bars for each room
                rooms.forEach(r => {
                    let p = (r.setpoint - 16) / 14;
                    document.getElementById(`prog-${r.id}`).style.strokeDasharray = `${p * 126}, 126`;
                });
            } catch (error) {
                console.error('Error fetching rooms:', error);
                container.innerHTML = '<p style="color: red;">Failed to load rooms. Please try again later.</p>';
            }
        }

        // Fetch rooms dynamically when the page loads
        window.addEventListener('DOMContentLoaded', fetchRooms);

        // Is not calling back to nucleo, just receiving updates
        window.addEventListener("DOMContentLoaded", (ev) => {
            const ws = new WebSocket(`/ws`);
            ws.onopen = () => {
                console.log("Connected to Zephyr WebSocket");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("Received JSON:", data);

                // Update temperature and humidity values
                if (data.temp_value !== undefined) {
                    rooms[data.room_id].temp_sensor_value = data.temp_value;
                    rooms[data.room_id].hum_sensor_value = data.hum_value;
                    
                    console.log("TEMP: ", data.temp_value);
                    document.getElementById(`real-${data.room_id}`).textContent = data.temp_value;
                }

                // Update light/led values
                if (data.light_value !== undefined) {

                    rooms[data.room_id].light_gpio_value = data.light_value;
                    const lightCheckbox = document.querySelector(`#card-${data.room_id} input[type="checkbox"]`);
                    if (lightCheckbox) {
                        lightCheckbox.checked = data.light_value === 1;
                    }
                    console.log(`Room ${data.room_id} light is now: ${data.light_value}`);
                }
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected");
            };

            ws.onerror = (err) => {
                alert("WebSocket Error Detected!");
                console.error("WebSocket error:", err);
            };
        })
    </script>
</body>
</html>