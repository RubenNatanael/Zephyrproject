<!-- VERY IMPORTANT!!!!!! - all temperature values must be send to backend with a scale of 100!!!(ex. 20.5 -> 2050)-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nucleo Smart Hub</title>
    <style>
        :root { --bg: #0f172a; --card: rgba(255,255,255,0.05); --primary: #8b5cf6; --text-dim: #94a3b8; }
        body { 
            background: var(--bg); color: white; font-family: sans-serif; 
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, 320px); gap: 20px; justify-content: center; width: 100%; }
        .card { 
            background: var(--card); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 24px; padding: 20px; transition: 0.3s; overflow: hidden; height: 300px;
        }
        .card.expanded { height: 520px; border-color: var(--primary); }
        .flex { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        
        /* Toggle Styling */
        .switch { width: 44px; height: 24px; position: relative; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #334155; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Dual Temp Display */
        .temp-box { position: relative; width: 180px; height: 140px; margin: 10px auto; touch-action: none; cursor: pointer;}
        .temp-display { 
            position: absolute; bottom: 5px; width: 100%; text-align: center; 
            display: flex; flex-direction: column; align-items: center; line-height: 1;
        }
        .real-val { font-size: 2.8rem; font-weight: 800; color: #fff; }
        .target-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; margin-top: 8px; letter-spacing: 1px;}
        .target-val { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        
        .schedule { opacity: 0; margin-top: 20px; transition: 0.3s; pointer-events: none; }
        .expanded .schedule { opacity: 1; pointer-events: auto; }
        .sched-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin-bottom: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <h2 style="color: #a855f7; margin-bottom: 30px;">Nucleo Control</h2>
    <div class="grid" id="container"></div>

    <script>
        // "temp" is what the sensor reads. "setpoint" is what the user wants.
        const rooms = [
            { room_id: 0, room_name: 'Test Room', temp_sensor_value: 2400, desired_temperature: 2200, light_gpio_value: 1, hum_sensor_value: 50, heat_relay_state: 0 },
            { room_id: 1, room_name: 'Living Room', temp_sensor_value: 2400, desired_temperature: 2200, light_gpio_value: 1, hum_sensor_value: 45, heat_relay_state: 0 },
            { room_id: 2, room_name: 'Bedroom', temp_sensor_value: 2000, desired_temperature: 1900, light_gpio_value: 0, hum_sensor_value: 40, heat_relay_state: 0 },
            { iroom_idd: 3, room_name: 'Kitchen', temp_sensor_value: 2200, desired_temperature: 2100, light_gpio_value: 1, hum_sensor_value: 55, heat_relay_state: 0 }
        ];

        function createCard(r) {
            return `
            <div class="card" id="card-${r.room_id}">
                <div class="flex">
                    <span style="font-weight:bold">${r.room_name}</span>
                    <button class="icon-btn" onclick="toggleEx(${r.room_id})">‚öôÔ∏è</button>
                </div>
                <div class="flex" style="margin: 15px 0; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 15px;">
                    <span>üí° Light</span>
                    <label class="switch">
                        <input type="checkbox" ${r.light_gpio_value ? 'checked' : ''} onchange="postLight(${r.room_id}, this.checked ? 1 : 0)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="temp-box" onmousedown="startDrag(event, ${r.room_id})" ontouchstart="startDrag(event, ${r.room_id})">
                    <svg viewBox="0 0 100 50" width="180">
                        <path d="M 10,45 A 40,40 0 0,1 90,45" fill="none" stroke="#2d2d44" stroke-width="6" stroke-linecap="round"/>
                        <path id="prog-${r.room_id}" d="M 10,45 A 40,40 0 0,1 90,45" fill="none" stroke="#8b5cf6" stroke-width="7" stroke-linecap="round" stroke-dasharray="0, 126"/>
                    </svg>
                    <div class="temp-display">
                        <div class="real-val">
                            <span id="real-${r.room_id}">${r.temp_sensor_value / 100}</span>¬∞
                            <span id="real-fire-${r.room_id}" style="font-size: 1rem; font-weight: 400; color: var(--text-dim);">üî•</span>
                        </div>
                        <div class="target-label">Target</div>
                        <div class="target-val"><span id="set-${r.room_id}">${r.desired_temperature / 100}</span>¬∞</div>
                    </div>
                </div>
                <div class="schedule">
                    <div class="sched-item flex"><span>Morning</span><b>21¬∞C</b></div>
                    <div class="sched-item flex"><span>Night</span><b>18¬∞C</b></div>
                </div>
            </div>`;
        }

        let dragging = false;
        
        window.onmousemove = window.ontouchmove = (e) => { if(dragging) update(e.touches ? e.touches[0] : e); };
        
        function startDrag(e, roomId) {
            dragging = true;
            activeId = roomId;
            update(e.touches ? e.touches[0] : e);
        }

        window.onmouseup = window.ontouchend = () => {
            if (dragging) {
                const room = rooms.find(r => r.room_id === activeId);
                if (room) postTemp(activeId, room.desired_temperature);
            }
            dragging = false;
        };

        const TEMP_MIN = 1000; // 10.00¬∞C
        const TEMP_MAX = 2800; // 28.00¬∞C
        const ARC_LEN  = 126;

        function updateSetpoint(roomId, value100) {
            // Clamp
            value100 = Math.max(TEMP_MIN, Math.min(TEMP_MAX, value100));

            // Update state
            const room = rooms.find(r => r.room_id === roomId);
            if (room) room.desired_temperature = value100;

            // UI text
            const setEl = document.getElementById(`set-${roomId}`);
            if (setEl) setEl.innerText = (value100 / 100).toFixed(1);

            // Progress arc
            const p = (value100 - TEMP_MIN) / (TEMP_MAX - TEMP_MIN);
            const prog = document.getElementById(`prog-${roomId}`);
            if (prog) prog.style.strokeDasharray = `${p * ARC_LEN}, ${ARC_LEN}`;
        }


        function update(e) {
            const box = document.querySelector(`#card-${activeId} .temp-box`);
            const rect = box.getBoundingClientRect();

            const p = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);

            // Convert slider ‚Üí temperature (√ó100)
            const value100 = Math.round(
                (TEMP_MIN + p * (TEMP_MAX - TEMP_MIN)) / 10
            ) * 10;

            updateSetpoint(activeId, value100);
        }


        // Call nucleo code to set light/led
        async function postLight(roomId, value) {
            let path_url = '/api/v1/light';
            let payload = JSON.stringify({"room_id" : roomId, "light_value" : value});
            try {
                await fetch(path_url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
            } catch (err) { console.error("Nucleo Offline", err); }
        }

        // Call nucleo code to set temperature
        async function postTemp(roomId, value) {
            try {
                const payload = JSON.stringify({"room_id" : roomId, "setpoint_temp_value" : value});
                await fetch('/api/v1/temp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
            } catch (err) { console.error("Nucleo Offline", err); }
        }

        async function fetchRooms() {
            const container = document.getElementById('container');
            container.innerHTML = '<p style="color: var(--text-dim);">Loading rooms...</p>';

            try {
                const response = await fetch('/api/v1/rooms');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const rooms = await response.json();

                // Clear the container and populate it with fetched room data
                container.innerHTML = rooms.map(createCard).join('');

                // Update progress bars for each room
                rooms.forEach(r => {
                    let p = (r.desired_temperature - 16) / 14;
                    document.getElementById(`prog-${r.room_id}`).style.strokeDasharray = `${p * 126}, 126`;
                    updateSetpoint(r.room_id, r.desired_temperature);
                });
            } catch (error) {
                console.error('Error fetching rooms:', error);
                container.innerHTML = '<p style="color: red;">Failed to load rooms. Please try again later.</p>';
            }
        }

        // Fetch rooms dynamically when the page loads
        window.addEventListener('DOMContentLoaded', fetchRooms);

        // // Is not calling back to nucleo, just receiving updates
        // window.addEventListener("DOMContentLoaded", (ev) => {
        //     const ws = new WebSocket(`/ws`);
        //     ws.onopen = () => {
        //         console.log("Connected to Zephyr WebSocket");
        //     };

        //     ws.onmessage = (event) => {
        //         const data = JSON.parse(event.data);
        //         console.log("Received JSON:", data);

        //         // Update temperature and humidity values
        //         if (data.temp_value !== undefined) {
        //             rooms[data.room_id].temp_sensor_value = data.temp_value * 100;
        //             rooms[data.room_id].hum_sensor_value = data.hum_value * 100;
                    
        //             console.log("TEMP: ", data.temp_value);
        //             document.getElementById(`real-${data.room_id}`).textContent = data.temp_value;
        //         }

        //         // Update light/led values
        //         if (data.light_value !== undefined) {

        //             rooms[data.room_id].light_gpio_value = data.light_value;
        //             const lightCheckbox = document.querySelector(`#card-${data.room_id} input[type="checkbox"]`);
        //             if (lightCheckbox) {
        //                 lightCheckbox.checked = data.light_value === 1;
        //             }
        //             console.log(`Room ${data.room_id} light is now: ${data.light_value}`);
        //         }
        //     };

        //     ws.onclose = () => {
        //         console.log("WebSocket disconnected");
        //     };

        //     ws.onerror = (err) => {
        //         alert("WebSocket Error Detected!");
        //         console.error("WebSocket error:", err);
        //     };
        // })


        // For testing on phones, to be removed later
         // --- LOGGING UTILITY FOR IPHONE ---
        const log = (msg, color = "white") => {
            const debugDiv = document.getElementById('debug-console');
            if (!debugDiv) return;
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.borderBottom = "1px solid #333";
            entry.style.padding = "2px";
            entry.innerText = `> ${msg}`;
            debugDiv.prepend(entry); // Newest logs at the top
        };

        // Error catching for general JS errors
        window.onerror = (m, u, l) => log(`JS ERR: ${m} (line ${l})`, "#ff4444");

        window.addEventListener("DOMContentLoaded", () => {
            // 1. Create the UI for the Debug Console
            const consoleDiv = document.createElement('div');
            consoleDiv.id = 'debug-console';
            consoleDiv.style = "position:fixed; bottom:0; left:0; width:100%; height:150px; background:rgba(0,0,0,0.9); color:#0f0; font-family:monospace; font-size:10px; overflow-y:auto; z-index:10000; border-top:2px solid #8b5cf6; padding:5px; pointer-events:none;";
            document.body.appendChild(consoleDiv);

            log("Initializing WebSocket...", "#8b5cf6");

            // 2. Use Dynamic URL (Works on iPhone & PC)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            log(`Connecting to: ${wsUrl}`);

            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log("CONNECTED TO NUCLEO ‚úÖ", "#2ecc71");
            };

            ws.onmessage = (event) => {
                try {
                    // Log raw data to see if iPhone is actually getting bytes
                    log(`Raw: ${event.data.substring(0, 30)}...`, "#aaa");
                    
                    const data = JSON.parse(event.data.trim());
                    
                    if (data.temp_value !== undefined) {
                        rooms[data.room_id].temp_sensor_value = data.temp_value;
                        rooms[data.room_id].hum_sensor_value = data.hum_value;
                        document.getElementById(`real-${data.room_id}`).textContent = rooms[data.room_id].temp_sensor_value / 100;
                        log(`Room ${data.room_id} Update: ${rooms[data.room_id].temp_sensor_value / 100}¬∞C`, "#8b5cf6");
                    }

                    if (data.light_value !== undefined) {
                        rooms[data.room_id].light_gpio_value = data.light_value;
                        const lightCheckbox = document.querySelector(`#card-${data.room_id} input[type="checkbox"]`);
                        if (lightCheckbox) lightCheckbox.checked = data.light_value === 1;
                    }

                    if (data.setpoint_temp_value !== undefined) {
                        rooms[data.room_id].desired_temperature = data.setpoint_temp_value;
                        updateSetpoint(data.room_id, data.setpoint_temp_value);
                        log(`Room ${data.room_id} Setpoint Update: ${data.setpoint_temp_value / 100}¬∞C`, "#8b5cf6");
                    }
                    
                    if (data.heat_relay_state !== undefined) {
                        rooms[data.room_id].heat_relay_state = data.heat_relay_state;
                        document.getElementById(`real-fire-${data.room_id}`).style.opacity = data.heat_relay_state ? "1" : "0.1";
                        log(`Room ${data.room_id} Heat Relay State: ${data.heat_relay_state ? "ON" : "OFF"}`, "#8b5cf6");
                    }

                } catch (e) {
                    log(`JSON ERROR: ${e.message}`, "#ff4444");
                }
            };

            ws.onclose = (e) => {
            const states = ["CONNECTING", "OPEN", "CLOSING", "CLOSED"];
            const currentState = states[ws.readyState] || "UNKNOWN";
            log(`DISCONNECTED ‚ùå`, "#ff4444");
            log(`Reason: ${e.wasClean ? "Clean" : "Dirty/Abrupt"}`, "#ff4444");
            log(`Code: ${e.code}`, "#ff4444");
            log(`Final State: ${currentState}`, "#ff4444");
            
            if (e.code === 1006) {
                log("HINT: iPhone rejected the Frame or Handshake Hash.", "#f1c40f");
            }
        };

            ws.onerror = (err) => {
                log("WEBSOCKET ERROR DETECTED", "#ff4444");
            };
        });
    </script>
</body>
</html>